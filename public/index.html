<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRUZE Player</title>
    <style>
        :root { --theme-color: #e67e22; --bg-gradient: linear-gradient(135deg, #2c3e50, #4ca1af); --text-light: #ecf0f1; --text-dark: #bdc3c7; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg-gradient); color: var(--text-light); height: 100vh; overflow: hidden; }
        .app-container { display: none; }
        .app-container.active { display: block; }
        .header { background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); height: 60px; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { font-size: 20px; font-weight: bold; }
        .nav-tabs { display: flex; gap: 30px; margin-left: 40px; }
        .nav-tab { padding: 8px 0; cursor: pointer; font-weight: 500; color: var(--text-dark); border-bottom: 2px solid transparent; transition: all 0.3s ease; }
        .nav-tab.active { color: var(--theme-color); border-bottom-color: var(--theme-color); }
        .logout-btn { margin-left: auto; background: none; border: 1px solid var(--theme-color); color: var(--theme-color); padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .main-container { display: flex; height: calc(100vh - 60px); }
        .sidebar { width: 280px; background: rgba(0,0,0,0.5); backdrop-filter: blur(12px); border-right: 1px solid rgba(255,255,255,0.1); overflow-y: auto; padding: 20px 0; }
        .sidebar-title { padding: 0 20px 15px; font-size: 14px; font-weight: 600; color: var(--theme-color); text-transform: uppercase; }
        .category-list { list-style: none; }
        .category-item { padding: 12px 20px; cursor: pointer; transition: background 0.2s; border-left: 3px solid transparent; }
        .category-item:hover { background: rgba(255,255,255,0.1); }
        .category-item.active { background: rgba(230,126,34,0.1); border-left-color: var(--theme-color); color: var(--theme-color); font-weight: 500; }
        .content-area { flex: 1; overflow-y: auto; padding: 30px; }
        .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 25px; }
        .content-card { background: #34495e; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; }
        .content-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .card-poster { width: 100%; padding-top: 150%; background-size: cover; background-position: center; background-color: #2c3e50; }
        .card-title { padding: 12px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background: rgba(44, 62, 80, 0.8); margin-top: auto; }
        .loading, .error { padding: 80px 20px; text-align: center; font-size: 1.2em; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: var(--theme-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-close { position: absolute; top: 20px; right: 30px; background: none; border: none; color: white; font-size: 40px; cursor: pointer; z-index: 10; }
        /* Player Modal */
        #player-container { position: relative; width: 90%; max-width: 1200px; }
        #video-player { width: 100%; }
        /* Series Detail Modal */
        #series-detail-container { width: 95%; max-width: 1000px; height: 85vh; background: #2c3e50; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .series-header { padding: 20px; font-size: 24px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .series-body { display: flex; flex: 1; overflow: hidden; }
        .season-list { width: 220px; border-right: 1px solid rgba(255,255,255,0.1); overflow-y: auto; }
        .season-tab { padding: 15px 20px; cursor: pointer; }
        .season-tab.active { background: var(--theme-color); }
        .episode-list { flex: 1; overflow-y: auto; padding: 10px; }
        .episode-item { padding: 12px 20px; border-radius: 5px; cursor: pointer; margin: 5px; display: flex; align-items: center; gap: 15px; }
        .episode-item:hover { background: rgba(255,255,255,0.1); }
        .episode-number { background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 4px; font-weight: bold; }
        /* Login Screen */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-box { background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); padding: 40px; border-radius: 10px; width: 100%; max-width: 400px; text-align: center; }
        .login-box h2 { margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: white; }
        .login-box button { width: 100%; padding: 12px; background: var(--theme-color); border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2>Xtream GiriÅŸ Bilgileri</h2>
            <form id="login-form">
                <input type="text" id="xtream-host" placeholder="http://sunucu:port" required value="http://qruzetv.site:8080">
                <input type="text" id="xtream-username" placeholder="KullanÄ±cÄ± AdÄ±" required value="Akinbay1">
                <input type="password" id="xtream-password" placeholder="Åžifre" required value="3516akinbay54514">
                <button type="submit">GiriÅŸ Yap</button>
            </form>
        </div>
    </div>

    <div class="app-container">
        <header class="header">
            <div class="logo">ðŸŽ¬ QRUZE Player</div>
            <nav class="nav-tabs">
                <div class="nav-tab active" id="nav-movies" onclick="switchContent('movies')">Filmler</div>
                <div class="nav-tab" id="nav-series" onclick="switchContent('series')">Diziler</div>
            </nav>
            <button class="logout-btn" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </header>
        <main class="main-container">
            <aside class="sidebar" id="sidebar"></aside>
            <section class="content-area" id="content-area"></section>
        </main>
    </div>

    <div id="player-modal" class="modal">
        <button class="modal-close" onclick="closePlayer()">Ã—</button>
        <div id="player-container">
            <video id="video-player" controls autoplay></video>
        </div>
    </div>

    <div id="series-detail-modal" class="modal">
        <button class="modal-close" onclick="closeSeriesDetail()">Ã—</button>
        <div id="series-detail-container"></div>
    </div>

    <script>
        const state = { currentPage: 'movies', xtreamInfo: null, categories: { movies: [], series: [] }, currentCategoryId: null };
        const xtreamHost = () => state.xtreamInfo.host;

        document.addEventListener('DOMContentLoaded', () => {
            state.xtreamInfo = JSON.parse(localStorage.getItem('xtreamInfo'));
            if (state.xtreamInfo) showApp();
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        });

        function handleLogin(e) {
            e.preventDefault();
            let host = document.getElementById('xtream-host').value.trim();
            if (host && !/^https?:\/\//i.test(host)) host = 'http://' + host;
            state.xtreamInfo = { host, username: document.getElementById('xtream-username').value, password: document.getElementById('xtream-password').value };
            localStorage.setItem('xtreamInfo', JSON.stringify(state.xtreamInfo));
            showApp();
        }

        function logout() {
            localStorage.removeItem('xtreamInfo');
            window.location.reload();
        }

        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.querySelector('.app-container').classList.add('active');
            switchContent('movies');
        }

        async function apiFetch(endpoint) {
            const headers = new Headers({
                'x-xtream-host': state.xtreamInfo.host,
                'x-xtream-username': state.xtreamInfo.username,
                'x-xtream-password': state.xtreamInfo.password
            });
            const response = await fetch(endpoint, { headers });
            if (!response.ok) throw new Error(`Sunucu hatasÄ±: ${response.statusText}`);
            const data = await response.json();
            if (data.status !== 'success') throw new Error(data.message);
            return data.data;
        }

        async function switchContent(type) {
            state.currentPage = type;
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`nav-${type}`).classList.add('active');
            document.getElementById('content-area').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            if (state.categories.movies.length === 0 && state.categories.series.length === 0) {
                try {
                    const data = await apiFetch('/api/categories');
                    state.categories.movies = data.movieCategories;
                    state.categories.series = data.seriesCategories;
                } catch (error) {
                    document.getElementById('content-area').innerHTML = `<div class="error">${error.message}</div>`;
                    return;
                }
            }
            
            let categories;
            if (type === 'movies') {
                categories = state.categories.movies;
                state.currentCategoryId = categories.length > 0 ? categories[0].id : null;
            } else { // Diziler iÃ§in "TÃ¼m Diziler" seÃ§eneÄŸini ekle
                categories = [{ id: '*', name: 'TÃœM DÄ°ZÄ°LER' }, ...state.categories.series];
                state.currentCategoryId = '*'; // VarsayÄ±lan olarak "TÃ¼m Diziler" seÃ§ili gelsin
            }

            updateSidebar(categories);
            loadCategoryContent();
        }

        function updateSidebar(categories) {
            const listEl = document.getElementById('sidebar');
            listEl.innerHTML = `
                <div class="sidebar-title">${state.currentPage === 'movies' ? 'Film' : 'Dizi'} Kategorileri</div>
                <ul class="category-list">
                    ${categories.map(cat => `
                        <li class="category-item ${String(cat.id) === String(state.currentCategoryId) ? 'active' : ''}" onclick="selectCategory('${cat.id}')">
                            <span>${cat.name}</span>
                        </li>`).join('')}
                </ul>`;
        }

        function selectCategory(categoryId) {
            state.currentCategoryId = categoryId;
            let categories;
            if (state.currentPage === 'movies') {
                categories = state.categories.movies;
            } else {
                categories = [{ id: '*', name: 'TÃœM DÄ°ZÄ°LER' }, ...state.categories.series];
            }
            updateSidebar(categories);
            loadCategoryContent();
        }

        async function loadCategoryContent() {
            const contentArea = document.getElementById('content-area');
            if (state.currentCategoryId === null) {
                contentArea.innerHTML = `<div class="error">Kategori seÃ§ilmedi.</div>`;
                return;
            }
            contentArea.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            try {
                const data = await apiFetch(`/api/${state.currentPage}?category_id=${state.currentCategoryId}`);
                renderContent(contentArea, data);
            } catch (error) {
                contentArea.innerHTML = `<div class="error">Ä°Ã§erik yÃ¼klenemedi: ${error.message}</div>`;
            }
        }
        
        function renderContent(container, items) {
            container.innerHTML = Array.isArray(items) && items.length > 0
                ? `<div class="content-grid">${items.map(createCard).join('')}</div>`
                : '<div class="error">Bu kategoride iÃ§erik bulunamadÄ±.</div>';
        }

        function createCard(item) {
            const isSeries = state.currentPage === 'series';
            const title = item.name;
            const poster = item.cover || item.stream_icon || '';
            // Dizi iÃ§in series_id, film iÃ§in stream_id kullanÄ±lÄ±r.
            const id = isSeries ? item.series_id : item.stream_id;
            const action = isSeries ? `showSeriesDetail(${id}, '${title.replace(/'/g, "\\'")}')` : `playVideo(${id}, '${item.container_extension}')`;
            
            return `
                <div class="content-card" onclick="${action}">
                    <div class="card-poster" style="background-image: url('${poster}')"></div>
                    <div class="card-title">${title}</div>
                </div>`;
        }
        
        function playVideo(streamId, extension) {
            const { host, username, password } = state.xtreamInfo;
            const type = state.currentPage === 'movies' ? 'movie' : 'series';
            const url = `${host}/${type}/${username}/${password}/${streamId}.${extension}`;
            document.getElementById('video-player').src = url;
            document.getElementById('player-modal').classList.add('active');
        }

        function closePlayer() {
            const player = document.getElementById('video-player');
            player.pause();
            player.src = '';
            document.getElementById('player-modal').classList.remove('active');
        }

        function playEpisode(streamId, extension) {
            closeSeriesDetail();
            playVideo(streamId, extension);
        }

        async function showSeriesDetail(seriesId, title) {
            const modal = document.getElementById('series-detail-modal');
            const container = document.getElementById('series-detail-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            modal.classList.add('active');
            try {
                const seriesData = await apiFetch(`/api/series_info/${seriesId}`);
                renderSeriesDetail(container, title, seriesData);
            } catch (error) {
                container.innerHTML = `<div class="error">Dizi detaylarÄ± yÃ¼klenemedi: ${error.message}</div>`;
            }
        }

        function renderSeriesDetail(container, title, seriesData) {
            const seasons = seriesData.episodes;
            if (!seasons || Object.keys(seasons).length === 0) {
                container.innerHTML = `<div class="error">Bu dizi iÃ§in bÃ¶lÃ¼m bilgisi bulunamadÄ±.</div>`;
                return;
            }
            const seasonNumbers = Object.keys(seasons).sort((a,b) => parseInt(a) - parseInt(b));
            container.innerHTML = `
                <div class="series-header">${title}</div>
                <div class="series-body">
                    <div class="season-list">
                        ${seasonNumbers.map((sNum, index) => `<div class="season-tab ${index === 0 ? 'active' : ''}" id="season-tab-${sNum}" onclick="switchSeason(this, ${sNum})">${seasons[sNum][0].season_number}. Sezon</div>`).join('')}
                    </div>
                    <div class="episode-list">
                        ${seasonNumbers.map((sNum, index) => `
                            <div id="episode-list-${sNum}" style="display: ${index === 0 ? 'block' : 'none'};">
                                ${seasons[sNum].sort((a,b) => a.episode_num - b.episode_num).map(ep => `<div class="episode-item" onclick="playEpisode(${ep.id}, '${ep.container_extension}')">
                                    <span class="episode-number">${ep.episode_num}</span>
                                    <span>${ep.title || `BÃ¶lÃ¼m ${ep.episode_num}`}</span>
                                </div>`).join('')}
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }
        
        function switchSeason(tabElement, seasonNum) {
            document.querySelectorAll('.season-tab').forEach(t => t.classList.remove('active'));
            tabElement.classList.add('active');
            document.querySelectorAll('.episode-list > div').forEach(el => el.style.display = 'none');
            document.getElementById(`episode-list-${seasonNum}`).style.display = 'block';
        }

        function closeSeriesDetail() {
            document.getElementById('series-detail-modal').classList.remove('active');
            document.getElementById('series-detail-container').innerHTML = '';
        }
    </script>
</body>
</html>